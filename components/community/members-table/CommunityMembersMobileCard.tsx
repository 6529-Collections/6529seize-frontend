import type { ApiCommunityMemberOverview } from "@/generated/models/ApiCommunityMemberOverview";
import { formatNumberWithCommasOrDash, getTimeAgoShort } from "@/helpers/Helpers";
import UserCICAndLevel, {
  UserCICAndLevelSize,
} from "@/components/user/utils/UserCICAndLevel";
import {
  isEthereumAddress,
  isAutoGeneratedHandle,
} from "@/helpers/AllowlistToolHelpers";
import { ImageScale, getScaledImageUri } from "@/helpers/image.helpers";
import Link from "next/link";

export default function CommunityMembersMobileCard({
  member,
  rank,
}: {
  readonly member: ApiCommunityMemberOverview;
  readonly rank: number;
}) {
  const isNotProfile = isEthereumAddress(member.detail_view_key);
  const isProfile = !isNotProfile;
  const textColorClass = isProfile ? "tw-text-iron-50" : "tw-text-iron-400";
  const path = `/${member.detail_view_key}`;

  return (
    <Link
      href={path}
      className="tw-flex tw-flex-col tw-gap-y-3 tw-p-4 tw-rounded-xl tw-bg-iron-900/80 tw-border tw-border-iron-800 tw-border-solid tw-backdrop-blur-md active:tw-bg-iron-800 tw-transition-all tw-duration-200 tw-no-underline tw-overflow-hidden tw-shadow-sm tw-shadow-black/20"
    >
      <div className="tw-flex tw-justify-between tw-items-center tw-w-full">
        <div className="tw-flex tw-items-center tw-gap-x-3">
          <span className="tw-text-iron-400 tw-text-sm tw-font-medium">
            #{rank}
          </span>
          <div className="tw-flex-shrink-0 tw-h-10 tw-w-10 tw-rounded-md tw-overflow-hidden tw-ring-1 tw-ring-white/10 tw-bg-iron-900 tw-flex tw-items-center tw-justify-center">
            {member.pfp && (
              <img
                src={getScaledImageUri(member.pfp, ImageScale.W_AUTO_H_50)}
                alt={`${member.display} avatar`}
                className="tw-h-full tw-w-full tw-object-contain tw-mx-auto"
              />
            )}
          </div>
          <div className="tw-flex tw-items-center tw-gap-x-1.5">
            <UserCICAndLevel
              level={member.level}
              size={UserCICAndLevelSize.SMALL}
            />
            <div
              className={`tw-overflow-hidden tw-min-w-0 ${
                isEthereumAddress(member.detail_view_key) ||
                isAutoGeneratedHandle(member.detail_view_key)
                  ? "tw-max-w-[10rem] tw-truncate"
                  : ""
              }`}
            >
              <span className={`tw-text-sm tw-font-medium ${textColorClass}`}>
                {member.display}
              </span>
            </div>
          </div>
        </div>
        {member.last_activity && (
          <span className="tw-text-iron-400 tw-text-xs tw-whitespace-nowrap">
            Last seen {getTimeAgoShort(member.last_activity, Date.now(), true)} ago
          </span>
        )}
      </div>

      <div className="tw-grid tw-grid-cols-3 tw-gap-3">
        <div className="tw-flex tw-flex-col">
          <span className="tw-text-iron-400 tw-text-[10px] tw-mb-0.5">TDH</span>
          <span className="tw-font-semibold tw-text-iron-50 tw-text-xs">
            {formatNumberWithCommasOrDash(member.tdh)}
          </span>
          <span className="tw-text-iron-500 tw-text-[10px]">
            {member.tdh_rate > 0 ? "+" : ""}
            {formatNumberWithCommasOrDash(Math.round(member.tdh_rate))}
          </span>
        </div>
        <div className="tw-flex tw-flex-col">
          <span className="tw-text-iron-400 tw-text-[10px] tw-mb-0.5">xTDH</span>
          <span className="tw-font-semibold tw-text-iron-50 tw-text-xs">
            {formatNumberWithCommasOrDash(Math.round(member.xtdh))}
          </span>
          <span className="tw-text-iron-500 tw-text-[10px]">
            {member.xtdh_rate > 0 ? "+" : ""}
            {formatNumberWithCommasOrDash(Math.round(member.xtdh_rate))}
          </span>
        </div>
        <div className="tw-flex tw-flex-col">
          <span className="tw-text-iron-400 tw-text-[10px] tw-mb-0.5">Combined TDH</span>
          <span className="tw-font-semibold tw-text-iron-50 tw-text-xs">
            {formatNumberWithCommasOrDash(Math.round(member.combined_tdh))}
          </span>
          <span className="tw-text-iron-500 tw-text-[10px]">
            {member.combined_tdh_rate > 0 ? "+" : ""}
            {formatNumberWithCommasOrDash(Math.round(member.combined_tdh_rate))}
          </span>
        </div>
      </div>

      <div className="tw-flex tw-items-center tw-gap-x-4">
        <span className="tw-text-iron-400 tw-text-[10px]">xTDH Grants</span>
        <div className="tw-flex tw-items-center tw-gap-x-1">
          <span className="tw-text-iron-400 tw-text-xs">In:</span>
          <span className="tw-font-semibold tw-text-iron-50 tw-text-xs">
            {formatNumberWithCommasOrDash(Math.round(member.xtdh_incoming))}
          </span>
        </div>
        <div className="tw-flex tw-items-center tw-gap-x-1">
          <span className="tw-text-iron-400 tw-text-xs">Out:</span>
          <span className="tw-font-semibold tw-text-iron-50 tw-text-xs">
            {formatNumberWithCommasOrDash(Math.round(member.xtdh_outgoing))}
          </span>
        </div>
      </div>

      <div className="tw-flex tw-items-center tw-gap-x-4">
        <span className="tw-text-iron-400 tw-text-[10px]">Peer Score</span>
        <div className="tw-flex tw-items-center tw-gap-x-1">
          <span className="tw-text-iron-400 tw-text-xs">REP:</span>
          <span className="tw-font-semibold tw-text-iron-50 tw-text-xs">
            {formatNumberWithCommasOrDash(member.rep)}
          </span>
        </div>
        <div className="tw-flex tw-items-center tw-gap-x-1">
          <span className="tw-text-iron-400 tw-text-xs">NIC:</span>
          <span className="tw-font-semibold tw-text-iron-50 tw-text-xs">
            {formatNumberWithCommasOrDash(member.cic)}
          </span>
        </div>
      </div>
    </Link>
  );
}
