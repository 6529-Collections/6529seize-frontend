name: AI Code Review on Comment
on:
  issue_comment:
    types: [created]

jobs:
  ai-code-review:
    # Only run on PR comments that contain "@review"
    if: github.event.issue.pull_request && contains(github.event.comment.body, '@review')
    runs-on: ubuntu-latest

    steps:
      - name: Get PR details
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('base_sha', pr.base.sha);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('pr_number', pr.number);

      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-info.outputs.head_sha }}
          fetch-depth: 0

      - name: AI Code Review Analysis
        uses: 6529-Collections/ai-code-review-action@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          max-atomic-size: '15'
        env:
          # Help the action understand the PR context
          GITHUB_HEAD_REF: ${{ steps.pr-info.outputs.head_ref }}
          GITHUB_BASE_REF: ${{ steps.pr-info.outputs.base_ref }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
